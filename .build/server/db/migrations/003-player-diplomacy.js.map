{
  "version": 3,
  "sources": ["../../../../server/db/migrations/003-player-diplomacy.js"],
  "sourcesContent": ["module.exports = {\n    async migrate(db) {\n        const games = db.collection('games');\n\n        // Clear out any old games.\n        await games.updateMany({\n            $and: [\n                { 'state.endDate': { $ne: null } },\n                { 'galaxy.players.diplomacy.allies': { $ne: null } },\n                { 'galaxy.players.diplomacy.playerId': { $eq: null } }\n            ]\n        }, {\n            $set: {\n                'galaxy.players.$[].diplomacy': []\n            }\n        });\n\n        // In progress games:\n        let dbWrites = [];\n\n        await games.find({\n            $and: [\n                { 'state.endDate': { $eq: null } },\n                { 'galaxy.players.diplomacy.allies': { $ne: null } },\n                { 'galaxy.players.diplomacy.playerId': { $eq: null } }\n            ]\n        }).forEach(async game => {\n            let players = game.galaxy.players.filter(p => p.diplomacy.allies);\n            let diplo;\n\n            for (let player of players) {\n                diplo = player.diplomacy.allies.map(a => {\n                    return {\n                        playerId: a,\n                        status: 'allies'\n                    }\n                });\n\n                // For in progress games, default all other players to enemies.\n                if (game.state.startDate != null && game.state.endDate == null) {\n                    for (let otherPlayer of game.galaxy.players) {\n                        if (otherPlayer._id.toString() === player._id.toString()) {\n                            continue;\n                        }\n        \n                        if (diplo.find(p => {\n                            return p.playerId.toString() === otherPlayer._id.toString();\n                        })) {\n                            continue;\n                        }\n        \n                        diplo.push({\n                            playerId: otherPlayer._id,\n                            status: 'enemies'\n                        });\n                    }\n                }\n\n                dbWrites.push({\n                    updateOne: {\n                        filter: {\n                            _id: game._id,\n                            'galaxy.players._id': player._id\n                        },\n                        update: {\n                            $set: {\n                                'galaxy.players.$.diplomacy': diplo\n                            }\n                        }\n                    }\n                });\n            }\n        });\n\n        if (dbWrites.length) {\n            await games.bulkWrite(dbWrites);\n        }\n    }\n};\n"],
  "mappings": ";AAAA,OAAO,UAAU;AAAA,EACb,MAAM,QAAQ,IAAI;AACd,UAAM,QAAQ,GAAG,WAAW,OAAO;AAGnC,UAAM,MAAM,WAAW;AAAA,MACnB,MAAM;AAAA,QACF,EAAE,iBAAiB,EAAE,KAAK,KAAK,EAAE;AAAA,QACjC,EAAE,mCAAmC,EAAE,KAAK,KAAK,EAAE;AAAA,QACnD,EAAE,qCAAqC,EAAE,KAAK,KAAK,EAAE;AAAA,MACzD;AAAA,IACJ,GAAG;AAAA,MACC,MAAM;AAAA,QACF,gCAAgC,CAAC;AAAA,MACrC;AAAA,IACJ,CAAC;AAGD,QAAI,WAAW,CAAC;AAEhB,UAAM,MAAM,KAAK;AAAA,MACb,MAAM;AAAA,QACF,EAAE,iBAAiB,EAAE,KAAK,KAAK,EAAE;AAAA,QACjC,EAAE,mCAAmC,EAAE,KAAK,KAAK,EAAE;AAAA,QACnD,EAAE,qCAAqC,EAAE,KAAK,KAAK,EAAE;AAAA,MACzD;AAAA,IACJ,CAAC,EAAE,QAAQ,OAAM,SAAQ;AACrB,UAAI,UAAU,KAAK,OAAO,QAAQ,OAAO,OAAK,EAAE,UAAU,MAAM;AAChE,UAAI;AAEJ,eAAS,UAAU,SAAS;AACxB,gBAAQ,OAAO,UAAU,OAAO,IAAI,OAAK;AACrC,iBAAO;AAAA,YACH,UAAU;AAAA,YACV,QAAQ;AAAA,UACZ;AAAA,QACJ,CAAC;AAGD,YAAI,KAAK,MAAM,aAAa,QAAQ,KAAK,MAAM,WAAW,MAAM;AAC5D,mBAAS,eAAe,KAAK,OAAO,SAAS;AACzC,gBAAI,YAAY,IAAI,SAAS,MAAM,OAAO,IAAI,SAAS,GAAG;AACtD;AAAA,YACJ;AAEA,gBAAI,MAAM,KAAK,OAAK;AAChB,qBAAO,EAAE,SAAS,SAAS,MAAM,YAAY,IAAI,SAAS;AAAA,YAC9D,CAAC,GAAG;AACA;AAAA,YACJ;AAEA,kBAAM,KAAK;AAAA,cACP,UAAU,YAAY;AAAA,cACtB,QAAQ;AAAA,YACZ,CAAC;AAAA,UACL;AAAA,QACJ;AAEA,iBAAS,KAAK;AAAA,UACV,WAAW;AAAA,YACP,QAAQ;AAAA,cACJ,KAAK,KAAK;AAAA,cACV,sBAAsB,OAAO;AAAA,YACjC;AAAA,YACA,QAAQ;AAAA,cACJ,MAAM;AAAA,gBACF,8BAA8B;AAAA,cAClC;AAAA,YACJ;AAAA,UACJ;AAAA,QACJ,CAAC;AAAA,MACL;AAAA,IACJ,CAAC;AAED,QAAI,SAAS,QAAQ;AACjB,YAAM,MAAM,UAAU,QAAQ;AAAA,IAClC;AAAA,EACJ;AACJ;",
  "names": []
}
